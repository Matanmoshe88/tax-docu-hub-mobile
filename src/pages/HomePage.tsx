import React from 'react';
import { useNavigate } from 'react-router-dom';
import { PortalLayout } from '@/components/PortalLayout';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { FileText, LogIn, LogOut, User } from 'lucide-react';
import { useSalesforceData } from '@/hooks/useSalesforceData';
import { useAuth } from '@/hooks/useAuth';

export const HomePage: React.FC = () => {
  const navigate = useNavigate();
  const { clientData, isLoading, recordId } = useSalesforceData();
  const { user, signOut } = useAuth();

  const handleNext = () => {
    navigate(`/signature/${recordId || 'demo'}`);
  };

  const handleAuthAction = () => {
    if (user) {
      signOut();
    } else {
      navigate('/auth');
    }
  };

  const contractText = `בין : קוויק טקס (שם רשום: "ג'י.אי.אמ גלובל")   ח"פ: 513218453      (להלן: "קוויקטקס" ו/או "החברה")
לבין:    ${clientData.firstName} ${clientData.lastName}                                                   ת"ז: ${clientData.idNumber}                                    (להלן: "הלקוח")
שנחתם בתאריך : ${new Date().toLocaleDateString('he-IL')}

הואיל והלקוח מאשר בזאת כי הינו מבקש לבדוק את זכאותו להחזרי מס באמצעות ג'י.אי.אמ גלובל ניהול והשקעות בע"מ ח.פ. 513218453 להלן: ("קוויקטקס" ו/או "החברה") שכתובתה ת.ד. 11067, פתח-תקווה מיקוד 4934829 מול כלל הרשויות לרבות מס הכנסה וביטוח לאומי לצורך ייצוגו וטיפולו בקבלת ההחזר ממס הכנסה (להלן: "החזר המס") לשנים 2023-2018 (להלן: "תקופת המס") ולבצע עבורו את הפעולות הנדרשות על מנת לקבל החזר מס במקרה של זכאות;

והואיל והחברה - המעסיקה רו"ח ויועצי מס ועוסקת במתן שירותים אל מול רשויות המס לשם ביצוע החזרי מס לשכירים והגשת דוחות כספיים- מסכימה ליטול על עצמה את ייצוגו של הלקוח בהליך החזר המס;

לפיכך, הוצהר, הוסכם והותנה בין הצדדים כדלקמן:

1. החברה מספקת שירות לטיפול בהחזרי מס לשכירים מרשויות המס השונות, תוך ליווי הלקוח והגשת בקשות להחזר מיסים בשמו. תנאי סף לבדיקת הזכאות הוא שהלקוח היה שכיר ושילם מס הכנסה בשש השנים האחרונות, והלקוח מצהיר כי עומד בתנאי הסף כאמור לעיל. הטיפול של החברה כולל הזמנת המסמכים הרלוונטיים מרשויות המס בשם הלקוח, בחינתם על ידי אנשי מקצוע (רואי חשבון ו/או יועצי מס) ובמידה ונתוני הלקוח עונים על התנאים להחזר, תוגש בשמו של הלקוח בקשה להחזר מס (להלן: "השירות").

2. השירות הניתן הוא לטיפול בהחזר מס בלבד (לצורך הסכם זה, המונח "החזר מס" יהיה הסכום שייקבע על פי שומת מס הכנסה לתקופה הרלוונטית, לפני כל קיזוז ו/או עיקול בגין חוב המגיע ממנו לצד ג') ואינו כולל כל עניין ו/או טיפול אחרים מלבד כמפורט במפורש לעיל ולהלן. כל שירות שאינו חלק מתהליך קבלת החזרי המס כגון תיאום מס, סגירת תיקים פתוחים במס הכנסה וכד' יהיה כרוך בתשלום נוסף על פי תעריפי החברה ובהתאם לשיקול דעתה הבלעדי של החברה.

3. הלקוח מאשר בזאת לחברה לטפל עבורו בהחזרי המס לשנים 2026-2017 (להלן: "תקופת המס") ולשם כך לבצע עבור הלקוח את הפעולות הנדרשות על מנת לקבל החזרי מס ולטפל בכל הנוגע בדבר, לרבות בדיקת זכאותו להחזרי מס ומייפה את כוחה של החברה ו/או רואה חשבון מטעמה ו/או מי מטעמה לפנות בשמו ובמקומו לרשויות המס או לגופים הרלוונטיים אחרים, לרבות מס הכנסה וביטוח לאומי, וזאת על מנת לבקש, לאסוף או להגיש את המסמכים הדרושים או על מנת שיוכל לפעול בכל דרך אחרת הנדרשת לבדיקת זכאות הלקוח להחזרי מס לטובת טיפול בקבלת החזר, וזאת ללא צורך בעדכון הלקוח או קבלת אישור הלקוח לגבי כל השנים המצוינות בתקופת המס.

4. כמו כן, ידוע ללקוח כי לצורך טיפול יעיל ומהיר הוא יידרש לחתום על מסמכים לרבות בקשה לרישום ייצוג ו/או מתן ייפוי הכוח המאפשר לחברה ו/או מי מטעמה להציג ולהגיש כל מסמך ומידע השייך ללקוח לביטוח לאומי ו/או לרשויות המס, המצ"ב להסכם זה (ראה מצ"ב יפוי כח כנספח א'), לטובת ביצוע בדיקת הזכאות וטיפול בהחזר המס, והלקוח מאשר לחברה ו/או מי מטעמה לקבל עבורו את כל הנתונים והמסמכים הרלוונטיים הנדרשים לצורך הטיפול בהחזר המס, ומתחייב לשתף פעולה להשגת כלל המסמכים והנתונים הנדרשים לצורך בדיקת זכאות הלקוח להחזר מס והגשת הדו"ח.

5. אין בבדיקותיה ושירותיה של החברה להבטיח החזרת מס בפועל. כמו כן, לחברה לא תהיה כל אחריות כלפי הלקוח, במישרין ו/או בעקיפין, בכל תוצאת הבדיקה ו/או החלטה ו/או נימוק ו/או כל דרישה שהיא, בעבר, הווה ובעתיד, של רשויות המס והמוסד לביטוח לאומי מהלקוח, לרבות חבות מס ו/או שינויים בתקנות ובנהלים של רשויות המס שיש בהם כדי להשפיע על אי קבלת ההחזר, סכום ההחזר ו/או מועד קבלתו ו/או במקרה של דחיית הבקשה, באופן מלא או חלקי, או גובה ההחזר, מכל סיבה שהיא. למען הסר ספק, החברה לא מתחייבת כי הלקוח יקבל החזר מס בפועל וללקוח לא תהא כל טענה ו/או דרישה ו/או תביעה נגד החברה בקשר להחלטת הרשויות.

6. הלקוח מצהיר ומתחייב שלא לטפל בהחזרי המס בתקופת המס שבטיפול בכל דרך אחרת, לרבות בדו"ח פרטי, כמו כן מתחייב הלקוח להעביר לחברה כל מסמך ו/או אסמכתא ו/או מידע הנחוצים לטובת הייצוג ללא דיחוי. הלקוח מתחייב לאשר את הייצוג באזור האישי במס הכנסה ולשתף פעולה. הלקוח מתחייב לפעול בשקיפות מלאה עם החברה ולהעביר מידע נכון ומלא לרבות לעניין הדיווחים לרשויות המס או לגורמים אחרים ולרבות כלל הנתונים הרלוונטיים אודותיו ואודות משפחתו באופן מלא, אמיתי ומדויק ומצהיר כי ידוע לו שהחברה מתקשרת אתו על בסיס הנתונים כאמור. הלקוח מצהיר כי מסר לחברה את כל המסמכים, הנתונים והפרטים שהיו בידיו ובידיעתו כי פרט להכנסות עליהן דיווח, לא היו לו או לבת/בן זוגו/ה הכנסות נוספות בארץ או ובחו"ל, מכל מקור שהוא, בין אם ממשלח יד ובין אם ממקור אחר.

7. הלקוח מצהיר ומודע לכך כי אי שיתוף פעולה מצד הלקוח ואי מסירת המידע או מסירת מידע שאינו נכון ו/או עדכני ו/או מלא עלול לעכב את מתן השירות או לגרום לסירוב הבקשה וללקוח לא יהיה בגין עיכוב ו/או סירוב כאמור כל טענה ו/או דרישה ו/או תביעה כנגד החברה. יובהר כי החברה תגיש את הבקשה להחזר מס על סמך מידע שהתקבל מאת הלקוח כמו שהוא וכי לחברה אין אחריות ישירה ו/או שילוחית לנכונותו, כמו כן לחברה לא תהיה כל אחריות כלפי הלקוח, במישרין ו/או בעקיפין, בכל דרישה שהיא, בעבר, הווה ובעתיד, של רשויות המס והמוסד לביטוח לאומי מהלקוח, לרבות חבות מס ו/או שינויים בתקנות שיכולים להשפיע על אי קבלת ההחזר, סכום ההחזר ו/או מועד קבלתו.

8. בעת מסירת פרטים אישיים, בהזמנת שירות או מוצר, מאשר הלקוח לחברה לפנות אליו בכל אמצעי תקשורת שתראה לנכון, בהצעות ומידע שיווקי ופרסומי (לרבות על פי סעיף 30א' לחוק התקשורת) הקשור לשירותי החברה ולמוצרים המשווקים באמצעותה. אם אין הלקוח מעוניין בפניות החברה בכלל או באמצעות אמצעי תקשורת ספציפי בפרט, עליו להודיע על כך לחברה באחת מדרכי התקשורת המפורטות באתר החברה.

18. תנאי תשלום: הלקוח מתחייב לשלם לחברה עמלה בגובה של ${clientData.commissionRate} מסכום ההחזר בתוספת מע"מ (להלן: "עמלה") וזאת רק לאחר קבלת הכסף לחשבון הבנק של הלקוח.

[... המשך תנאי החוזה עד סוף המסמך...]`;

  if (isLoading) {
    return (
      <PortalLayout
        currentStep={1}
        totalSteps={4}
        nextLabel="טוען..."
        onNext={() => {}}
      >
        <div className="text-center py-12">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
          <p className="text-muted-foreground">טוען נתוני לקוח...</p>
        </div>
      </PortalLayout>
    );
  }

  return (
    <PortalLayout
      currentStep={1}
      totalSteps={4}
      onNext={handleNext}
      nextLabel="אני מסכים להמשך"
    >
      <div className="space-y-6 animate-fade-in">
        {/* Auth Section */}
        <div className="flex justify-between items-center">
          <div className="text-sm text-muted-foreground">
            {user ? `מחובר כ: ${user.email}` : 'לא מחובר'}
          </div>
          <Button
            variant={user ? "outline" : "default"}
            size="sm"
            onClick={handleAuthAction}
            className="gap-2"
          >
            {user ? (
              <>
                <LogOut className="h-4 w-4" />
                התנתקות
              </>
            ) : (
              <>
                <LogIn className="h-4 w-4" />
                התחברות
              </>
            )}
          </Button>
        </div>

        {/* Header */}
        <div className="text-center space-y-4">
          <div className="flex justify-center">
            <div className="bg-primary/10 p-4 rounded-full">
              <FileText className="h-8 w-8 text-primary" />
            </div>
          </div>
          <h1 className="text-3xl font-bold text-foreground">הסכם שירות</h1>
          <p className="text-muted-foreground max-w-2xl mx-auto">
            אנא קרא את הסכם השירות בעיון לפני המעבר לשלב הבא. החוזה מפרט את התנאים והזכויות שלך.
          </p>
        </div>

        {/* Contract Content - Full Width */}
        <div className="w-screen -mx-4 sm:-mx-6 lg:-mx-8 xl:-mx-12">
          <div className="px-4 sm:px-6 lg:px-8 xl:px-12 py-6 bg-background">
            <div className="text-xs sm:text-sm leading-6 sm:leading-7 whitespace-pre-wrap font-hebrew text-right max-w-none">
              {contractText}
            </div>
          </div>
        </div>

        {/* Important Notice */}
        <Card className="border-warning shadow-card">
          <CardContent className="pt-6">
            <div className="flex items-start gap-3">
              <div className="bg-warning/10 p-2 rounded-full mt-1">
                <FileText className="h-4 w-4 text-warning" />
              </div>
              <div className="space-y-2">
                <h3 className="font-semibold text-warning">שים לב</h3>
                <p className="text-sm text-muted-foreground">
                  על ידי לחיצה על "אני מסכים להמשך" אתה מאשר שקראת והבנת את תנאי ההסכם ומסכים לכל התנאים המפורטים בו.
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
    </PortalLayout>
  );
};